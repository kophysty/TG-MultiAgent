# E2E: выявленные проблемы (issues) — 2026-01-14

Источник фактов: артефакты `data/evals/e2e-run*.json` (последний прогон 2026-01-14).

## P0 — критично (ломает функциональность / массово всплывает)

### 1) `notion.archive_idea`: после подтверждения часто падает с “Не получилось выполнить действие в Notion.”

- **Симптом**: агент спрашивает подтверждение “Архивировать эту идею?”, после подтверждения отвечает “Не получилось выполнить действие в Notion.”
- **Где видно**:
  - `data/evals/e2e-run1-core300.json`
  - Кейсы (пример): `ideas_archive_c2849778`, `ideas_archive_7e9191de`, `ideas_archive_1e024a63`, `ideas_archive_8e06ebed`, `ideas_archive_6fac6de4`, `ideas_archive_3316037d`
  - В этих кейсах `plan.tool.name = notion.archive_idea`
- **Где в коде**:
  - Вызов: `core/dialogs/todo_bot_callbacks.js` — ветка `kind === 'notion.archive_idea'`
  - Реализация репо: `core/connectors/notion/ideas_repo.js` — `archiveIdea({ pageId })` делает `patch pages/<id> { archived: true }`
- **Ожидаемое поведение**: идея архивируется, агент отвечает “Готово. Архивировал идею.”
- **Фактическое**: Notion-операция не проходит, но подробности причины теряются (пользователь видит только общий текст).
- **Предположения по корню**:
  - Notion API возвращает ошибку на `archived:true` (400/403/404/validation).
  - Выбранный `pageId` не соответствует идее / не существует / нет прав.
  - Ошибка маскируется на уровне callbacks (нет “кода/типа” в ответе).
- **Что сделать**:
  - Добавить **санитизированную диагностику**: в ответ пользователю (и в event logs) включать хотя бы `code`/`message` без токенов.
  - В callbacks при ошибке архивирования логировать `e.code/e.message` (без утечек).
  - Проверить корректность `ideasRepo.archiveIdea` для текущей схемы Notion (и что `pageId` действительно из Ideas DB).
- **Acceptance criteria**:
  - Архивирование идеи стабильно работает на E2E кейсах выше.
  - При сбое пользователь получает понятную причину уровня “нет доступа / не найдено / неверная опция”.

### 2) Social: “Не понял платформу” для формулировок с “инстаграм(е)” + “Выбор устарел” на inline-пиках

- **Симптом A**: “Не понял платформу. Выбери из списка:” при тексте “... в инстаграм”
- **Где видно**:
  - `data/evals/e2e-run1-core300.json`
  - Кейсы (пример): `social_create_880d1f74`, `social_create_ff5d3843` (userText: “…в инстаграм”)
- **Симптом B**: несколько раз подряд “Выбор устарел. Попробуй еще раз.”
  - Кейс (пример): `social_list_ff25a73b` (userText: “что в инстаграме”)
- **Где в коде**:
  - Нормализация платформ: `core/dialogs/todo_bot.js` — `SOCIAL_PLATFORM_ALIASES`, `normalizeSocialPlatform(...)`
  - Обработчик выбора платформы/списка: `core/dialogs/todo_bot_executor.js` (`social.pick_platform*`) + `core/dialogs/todo_bot_callbacks.js`
- **Ожидаемое поведение**:
  - “инстаграм/инстаграме/инсте/…” корректно маппится на Notion option (например, “Instagram”).
  - Inline выбор не “протухает” при автоклике/быстрых сценариях.
- **Фактическое**:
  - Платформа не распознаётся (частично из-за словоформ/пунктуации).
  - Callback “протухает” из-за рассинхрона `pending` и callback_data.
- **Что сделать**:
  - Нормализовать RU словоформы: добавить обработку “инстаграме/инсте/инсту/…” (простая нормализация окончаниями или `startsWith` по `инстаграм`).
  - Усилить сопоставление alias → Notion option:
    - либо через карту canonical→реальный option,
    - либо через сравнение normalized ключей.
  - В E2E (и, при необходимости, в боевом боте) сделать обработку “устаревшего выбора” более устойчивой:
    - в runner автокликать только **самый свежий actionId** по kind,
    - в callbacks игнорировать старые клики без спама (или давать 1 подсказку).
- **Acceptance criteria**:
  - В core/social кейсах с “инстаграм” нет сообщений “Не понял платформу”.
  - “Выбор устарел” не появляется пачками (в идеале 0 на нормальных кейсах).

## P1 — важное (устойчивость/качество, может всплывать в проде)

### 3) Planner: `Failed to parse OpenAI JSON` на нормальном смешанном вводе

- **Симптом**: `planner_error` с сообщением `Failed to parse OpenAI JSON: ...`
- **Где видно**:
  - `data/evals/e2e-run1-adv150.json`
  - Кейс: `adv_mixed_9763419b` (userText: `pokazhi spisok`)
- **Где в коде**:
  - JSON parse wrapper: `core/ai/agent_planner.js` (и похожие: `todo_intent.js`, `confirm_intent.js`, …)
- **Что сделать**:
  - Сделать парсинг **более терпимым** (извлечение JSON блока из текста) или
  - Перейти на гарантированный формат ответа (если используете response_format/json schema в OpenAI).
- **Acceptance criteria**:
  - На подобных коротких/смешанных вводах planner не падает парсером; максимум — возвращает `type:"chat"` с уточнением.

## P2 — наблюдаемость / поддержка (чтобы быстрее чинить)

### 4) Cleanup: фиксировать детали ошибок (есть `cleanupErrors=1`, но без расшифровки в отчете)

- **Симптом**:
  - `data/evals/e2e-run3-create200.json`: `summary.cleanupErrors = 1`
  - В логах ранее встречалось: `cleanup error (social <id>): Request failed with status code 400`
- **Проблема**: в итоговом JSON сейчас нет явного списка “какой pageId и почему”.
- **Что сделать**:
  - В `apps/evals/src/e2e_runner.js` добавить `report.summary.cleanupErrorItems[]`:
    - `{ domain, pageId, status, message }` (без секретов)
- **Acceptance criteria**:
  - По любому cleanup error видно: какой объект, какой домен, какой HTTP status/код.

## P3 — корректность тестового покрытия (чтобы выводы по “memory” были честными)

### 5) E2E runner: “memory/prefs показать” не вызывает реальные командные хендлеры `/prefs_pg`

- **Симптом**: в memory тестах запрос “покажи мои предпочтения” не показывает тестовые prefs (идёт как chat, без выполнения детерминированного хендлера).
- **Причина**: раннер тестирует `LLM planner -> executor`, а не командные детерминированные ветки бота.
- **Что сделать**:
  - Добавить режим раннера “bot-handler mode” для `/commands`:
    - если `userText` начинается с `/` — прокидывать в реальный обработчик сообщения бота, а не в planner.
  - В отчёте помечать такие кейсы отдельно (чтобы не смешивать с planner-путём).
- **Acceptance criteria**:
  - Кейсы `/prefs_pg` реально возвращают сохраненные prefs (тестовые), когда Postgres подключен.

---

## Приложение: артефакты, где смотреть

- `data/evals/e2e-run1-core300.json` — Core, включая проблемы по `notion.archive_idea` и social platform
- `data/evals/e2e-run1-adv150.json` — Adversarial, включая `planner_error` парсинга JSON
- `data/evals/e2e-run3-create200.json` — Create-heavy, включая `cleanupErrors`

