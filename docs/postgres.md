# Postgres: что хранить и консистентность

## Что именно хранить в Postgres

### 1) Операционка (то, чего в Notion нет и ему не место)

- `conversation_state` (на каком вопросе бот, какие варианты показали)
- `draft_tasks` (черновики до уточнения)
- `jobs/queue` (фоновые задания: транскрипция, sync, сводки)
- `dedupe` (message_id / update_id, чтобы не дублить)
- `preferences/memory` (твои дефолты, привычки, "если без даты - Inbox")
- `reminder_log` (что уже напомнили, чтобы не спамить)

Это не дублирование Notion, это "мозг и память" агента.

### 2) Кэш задач

Можно хранить только то, что нужно для быстрых ответов:

- `task_id` (`notion_page_id`)
- `title`, `due`, `status`, `section`, `priority`, `last_edited_time`
- возможно `body` (если нужно для поиска или Q&A)
- `hash/version` для детекта изменений

Это кэш, а не полноценная "вторая Notion".

## Как держать консистентность

- если бот сам создал или обновил задачу - сразу пишет в Notion и обновляет свой кэш (write-through)
- если ты поправил руками в Notion - периодический sync подтянет изменения по `last_edited_time`

## Нужно ли "настоящую БД"

Оптимум сейчас: Postgres.

Хранит:

- черновики задач (пока ты не ответил на уточнения)
- состояние диалогов (какой вопрос задан, что ждём)
- дедуп апдейтов (чтобы не создать 2 задачи)
- историю статусов или джоб (для мониторинга "что происходит")
- кеш всех доступных рабочих баз бота из Notion
- память предпочтений пользователя

Если позже захочешь поиск или векторы - мигрируем на Postgres + `pgvector`. Пока рано усложнять.


