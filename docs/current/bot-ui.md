# Бот UI и команды (текущая реализация)

Этот раздел описывает поведение “обычного” бота (команды и клавиатура), без учета AI (AI - опционален флагом).

## Команды

### /start

- Показывает клавиатуру быстрых команд.
- Пишет приветствие (без версии) и отдельным сообщением пишет версию бота (например `v0.1.0`).
- Если настроен Postgres (`POSTGRES_URL`) - автоматически включает напоминалки для этого чата (подписка).
 - Кнопка `Start` в reply keyboard работает так же, как команда `/start`.

### /list

- Загружает задачи из Notion.
- Показывает только активные задачи (не `Done`) и не показывает задачи с тегом `Deprecated`.
- Группирует по категориям (Tags).
- В UI может показывать `Today` как алиас тега `Inbox`.
- В версии `v0.1.7` исправлена ошибка, из-за которой команда могла отвечать `Failed to fetch tasks. Please try again later.`.

### /today

- Загружает задачи из Notion.
- “Сегодня” - это:
  - задачи с тегом `Inbox` (в UI отображаются как `Today`)
  - задачи с due date = сегодня (из других категорий)
  - задачи с высоким приоритетом (из других категорий)
- Не показывает задачи с тегом `Deprecated`.
- В версии `v0.1.7` исправлена ошибка, из-за которой команда могла отвечать `Failed to fetch tasks. Please try again later.`.

### /addtask

Ручной детерминированный сценарий добавления задачи (без AI):

1) Бот просит ввести текст задачи
2) Бот показывает inline клавиатуру выбора категории
3) В зависимости от категории:
   - для `Work` и `Home` после приоритета просит выбрать дату (календарь)
   - для других категорий после приоритета сразу создает задачу

Таймауты:

- Если пользователь не выбрал категорию за таймаут - задача добавится в Notion с тегом `Inbox`.

Категории:

- Список категорий берется динамически из Notion `Tags` options.
- `Deprecated` не показывается.
- `Today` в UI - это алиас: при выборе `Today` в Notion записывается тег `Inbox`.

### /struct

- Печатает структуру Notion базы (имя свойства и тип).
- В версии `v0.1.7` исправлена ошибка вызова репозитория задач в этой команде.
 - В текущей клавиатуре по умолчанию эта команда не показана, но ее можно вызвать вручную текстом `/struct`.

### /reminders_on

- Включает напоминалки в этом чате (нужен `POSTGRES_URL`).

### /reminders_off

- Выключает напоминалки в этом чате (нужен `POSTGRES_URL`).

## Клавиатура (reply keyboard)

По команде `/start` показывается клавиатура:

- `/today`
- `/list`
- `/addtask`
- `Start`
- `/reminders_on`
- `/reminders_off`

## Inline меню (manual add flow)

- Выбор категории: кнопки по категориям (Tags) + `Cancel`.
- Выбор приоритета: кнопки `skip` и значения из Notion `Priority` options.
- Выбор даты: календарь (для `Work` и `Home`).

## Важно

- Polling consumer должен быть один на токен: нельзя одновременно запускать несколько процессов бота на один и тот же токен.

## Notes (UX)

- Удаление задач через AI (фразы вида "удали") выполняется как перенос в `Deprecated` с подтверждением кнопками.
- Если пользователь перечисляет несколько задач в одном сообщении, бот может провести удаление цепочкой подтверждений.
- Устаревшие inline-клики (например, кнопка была нажата после таймаута) больше не отправляют сообщение "Выбор устарел" в чат: используется toast через callback query.


