# AI (текущая реализация)

Этот раздел описывает, что реально умеет AI в текущей версии бота.

## Что AI делает

- Определяет тип сообщения:
  - **вопрос** - отвечает прямо в чат
  - **задача** - извлекает поля задачи, показывает summary и просит подтверждение

## Подтверждение и корректировки

После того как бот показал summary задачи:

- Подтвердить можно:
  - кнопкой **Подтвердить**
  - текстом: **"да"**, **"подтверждаю"**, **"подтвердить"**, **"ок"**
- Отменить можно:
  - кнопкой **Отмена**
  - текстом: **"нет"**, **"отмена"**, **"отменить"**
- Любой другой текст считается уточнением: бот пересобирает черновик задачи и снова просит подтверждение.

## Категории (Tags) и ограничения

- Категории берутся **динамически** из Notion свойства **`Tags`** (options).
- AI **не имеет права** придумывать новые категории:
  - в prompt передается список допустимых категорий
  - если AI сомневается - выбирает **`Inbox`**
- `Deprecated`:
  - AI не выбирает эту категорию
- Алиас `Today`:
  - в UI может отображаться как `Today`
  - в Notion фактически используется тег **`Inbox`** (алиас Today - Inbox)
- `Every Day`:
  - можно выбирать для периодических задач-напоминаний

## Инструменты (что реально используется)

- **Telegram polling**: получение апдейтов через `node-telegram-bot-api`.
- **Notion Tasks CRUD**: создание и чтение задач через Notion API (`core/connectors/notion`).
- **OpenAI**: анализ текста и выдача структурированного JSON для вопрос/задача и полей задачи.

## Запросы списков и работа с Notion (tools)

Если AI включен (`TG_AI=1`), бот умеет принимать естественные запросы вида:

- "покажи задачи"
- "покажи инбокс"
- "покажи домашние"
- "покажи задачи на сегодня"
- "пометь 3 как выполненную"
- "удали задачу X" (фактически переносит в `Deprecated`)
- "покажи идеи"
- "добавь идею: ..."
- "удали идею X" (архивирует запись)
- "покажи посты tiktok"
- "добавь пост в tiktok: ..."
- "удали пост X" (архивирует запись)
- "добавь запись в дневник: ..."
- "покажи записи дневника за сегодня"
- "обнови запись дневника X"
- "удали запись дневника X" (архивирует запись)

### Фильтры по умолчанию

- По умолчанию в списках **не показываются** выполненные задачи (`Done`).
- Выполненные показываются только если явно попросить:
  - "покажи выполненные" - покажет только `Done`
  - "покажи все включая выполненные" - покажет все статусы

### Подтверждение tool-действий

Для действий, которые меняют данные (например: пометить выполненным, перенести в Deprecated, обновить задачу, добавить описание) бот просит подтверждение:

- кнопками **Подтвердить** / **Отмена**
- или текстом (fallback): "да" / "нет"

Также подтверждение используется при дедупликации:

- если при создании задачи, идеи, поста или записи дневника найдено точное совпадение по названию, бот спросит, создавать ли дубль.

### Синонимы категорий

- "инбокс", "входящие", "today" - категория `Inbox` (в UI может отображаться как `Today`)
- "домашние" - категория `Home`
- "рабочие", "работа" - категория `Work`

### "На сегодня"

- Фраза "задачи на сегодня" означает: задачи с due date = сегодня (по `TG_TZ`) плюс задачи из `Inbox`.

### Дата и время (важно)

- AI планер получает контекст времени:
  - текущий момент (UTC ISO)
  - текущий момент в `TG_TZ`
  - сам `TG_TZ`
- При создании задачи бот старается извлечь due date из текста пользователя детерминированно:
  - "сегодня/завтра/послезавтра" выставляются по `TG_TZ`
  - "сегодня в 15:00" превращается в ISO datetime с оффсетом (например `YYYY-MM-DDT15:00:00+03:00`)
- Это сделано, чтобы избежать двух классов ошибок:
  - модель "придумала" не тот день (например 2024 год)
  - сдвиг времени из-за интерпретации UTC против локального времени

## Ideas DB и Social Media Planner

### Ideas DB

- Создание, просмотр и обновление идей идет через отдельный репозиторий Ideas DB.
- "Удалить идею" означает архивировать страницу (Notion `archived=true`).
- Категория `Category` считается стабильной сущностью:
  - бот старается **переиспользовать существующие** значения из Notion options
  - бот **не должен плодить** новые категории по ошибке (например из-за неточного STT или перефразирования)
  - если категория не совпадает с существующими options, бот либо оставит категорию пустой, либо положит в `Concept` (если такая категория существует)
  - поля вроде `Area` и `Source` можно заполнять более свободно
  - `Area`:
    - если `Area` в Notion это `select` или `multi_select`, бот сначала пытается сметчить к существующим options
    - если подходящей опции нет, бот может создать новую option для `Area` (без дублей) и проставить ее

### Social Media Planner

- Создание и просмотр постов идет через Social Media Planner DB.
- "Удалить пост" означает архивировать страницу (Notion `archived=true`).
- Если при создании поста не указан `Platform`, бот попросит выбрать платформу кнопками.
- Если `Platform` указан неточно (например "фейсбук/facebook/fb"), бот попробует сметчить по существующим Notion options и только если не получилось - попросит выбрать кнопками.
- Если пользователь говорит дату вроде "сегодня/завтра/послезавтра", бот пытается автоматически проставить `Post date` при создании поста.

## Journal (личный дневник)

- Создание и просмотр записей идет через Journal DB.
- "Удалить запись дневника" означает архивировать страницу (Notion `archived=true`).
- Поля `Type`, `Topics`, `Context` считаются стабильными:
  - бот сначала сопоставляет с существующими значениями
  - если подходящего значения нет, бот может создать новый option (без дублей, по нормализации)
- При создании записи дневника бот **обязательно** заполняет:
  - `Type`
  - `Topics` (минимум 1)
  - `Context` (минимум 1)
  - `Mood` и `Energy` как числа **1-5** (если уверенности нет, ставит нейтральные `3/3`)

## Флаги запуска

- `TG_AI=1` - включает AI ветку.
- `TG_AI_MODEL=gpt-4.1` - модель для AI (по умолчанию в коде используется `gpt-4.1` если переменная не задана).
- `TG_DEBUG=1` - включает `[tg_debug]` логи.


