---
name: 03_2025-12-29_journal
overview: "Добавить поддержку Notion БД Journal как четвертый домен: CRUD тулзы (list/find/create/update/archive), извлечение полей из текста, нормализация опций, и интеграция в AI planner/executor. Реализацию делаем через текущий Notion HTTP клиент по NOTION_TOKEN, MCP настраиваем отдельно как опциональный слой."
todos:
  - id: add-journal-repo
    content: Добавить `core/connectors/notion/journal_repo.js` с CRUD и getOptions по паттерну ideas/social
    status: completed
  - id: wire-journal-main
    content: Подключить Journal DB id и repo в `apps/todo_bot/src/main.js`, прокинуть в `registerTodoBot`
    status: completed
    dependencies:
      - add-journal-repo
  - id: planner-add-journal-tools
    content: "Расширить `core/ai/agent_planner.js`: новые tool names и правила выбора дневника"
    status: completed
    dependencies:
      - wire-journal-main
  - id: executor-journal-tools
    content: Расширить `core/dialogs/todo_bot.js` обработкой journal tool calls, нормализацией опций и UX-уточнениями
    status: completed
    dependencies:
      - planner-add-journal-tools
  - id: docs-and-version
    content: Обновить docs (`docs/current/index.md`, `docs/current/ai.md`, `README.md`) и bump версии `apps/todo_bot` до 0.1.8
    status: completed
    dependencies:
      - executor-journal-tools
---

# План: Journal (Notion DB) toolkit

## Контекст и принципы

- Источник данных: Notion DB Journal (title property `Entry`).
- Доступ: используем текущий Notion HTTP клиент проекта (по `NOTION_TOKEN`), потому что MCP в Cursor использует отдельные креды и может не видеть все базы без дополнительной настройки.
- Правила полей:
- `Mood` и `Energy`: number, **нормализуем в шкалу 1-5** (округление и clamp).
- `Type`, `Topics`, `Context`: **только из существующих опций**. Если не матчится, оставляем пустым и задаем уточнение.
- Удаление: только `archive`.
- Лимиты: list/find возвращают максимум 15-20 элементов, чтобы не спамить чат.

## Почему MCP сейчас не видит базу и что нужно для доступа

MCP Notion в Cursor и наш `NOTION_TOKEN` - это разные контуры авторизации.

- Если вы хотите, чтобы я видел базы через MCP:
- **Hosted MCP (`mcp.notion.com`)**: нужно авторизоваться в Notion через OAuth и выдать доступ workspace и нужным страницам. Токен руками обычно не нужен.
- **Self-host `makenotion/notion-mcp-server`**: MCP серверу нужен `NOTION_TOKEN` той интеграции, которой расшарены базы. Плюс база должна быть расшарена именно этой интеграции.
- Практическая проверка: в Notion у DB должно быть `Share` или `Connections` с тем самым MCP integration. Если подключен `TG-MultiAgent`, а MCP работает под другой интеграцией, он ее не увидит.

В рамках этого спринта не блокируемся на MCP и делаем через обычный API.

## Изменения в коде

### 1) Новый Notion repo для дневника

- Добавить файл: [`core/connectors/notion/journal_repo.js`](core/connectors/notion/journal_repo.js)
- По паттерну [`core/connectors/notion/ideas_repo.js`](core/connectors/notion/ideas_repo.js) и [`core/connectors/notion/social_repo.js`](core/connectors/notion/social_repo.js)
- Методы:
- `getDatabase()`
- `getOptions()` - вытянуть options для `Type`, `Topics`, `Context`
- `listEntries({ type, topics, context, dateOnOrAfter, dateBefore, queryText, limit })`
- `findEntries({ queryText, limit })`
- `createEntry({ title, date, type, topics, mood, energy, context, description })`
- `updateEntry({ pageId, ...fields })` (правило: `undefined` не меняет поле, `null` очищает где возможно)
- `archiveEntry({ pageId })`
- `appendDescription({ pageId, text })`

Примечание по полям (точные имена подтверждены):

- `Entry` (title)
- `Date` (date)
- `Type` (select)
- `Topics` (multi_select)
- `Mood` (number)
- `Energy` (number)
- `Context` (multi_select)

### 2) Подключение DB id в запуске бота

- Обновить [`apps/todo_bot/src/main.js`](apps/todo_bot/src/main.js):
- добавить `NOTION_JOURNAL_DB_ID`
- создать `journalRepo` и передать в `registerTodoBot`
- добавить `databaseIds.journal`

### 3) Расширение planner schema

- Обновить [`core/ai/agent_planner.js`](core/ai/agent_planner.js):
- добавить tool names для дневника:
    - `notion.list_journal_entries`
    - `notion.find_journal_entries`
    - `notion.create_journal_entry`
    - `notion.update_journal_entry`
    - `notion.archive_journal_entry`
    - (опционально) `notion.append_journal_description`
- добавить правила выбора дневника:
    - если пользователь явно говорит дневник, запись дневника, рефлексия, итог дня
    - если в тексте много эмоций/событий и нет явного запроса на таски/идеи/соцпосты, можно выбрать дневник, но при низкой уверенности лучше спросить уточнение
- закрепить правило: новые опции для `Type/Topics/Context` не создаем, только выбираем из существующих или оставляем пустыми.

### 4) Executor: обработка новых tool calls + UX уточнений

- Обновить [`core/dialogs/todo_bot.js`](core/dialogs/todo_bot.js) в `executeToolPlan`:
- роутинг по `notion.*journal*`
- нормализация:
    - `mood`, `energy`: привести к 1-5
    - `type/topics/context`: подгрузить опции из `journalRepo.getOptions()` и матчить через существующую `normalizeMultiOptionValue`
- если есть неизвестные значения для type/topics/context:
    - не создавать новых
    - спросить уточняющий вопрос, предложить inline кнопки (как для платформ в social), если это удобно
- list/find: печатать компактный список (до 20 строк)

### 5) Конфигурация и документация

- Обновить `docs/current/index.md`:
- добавить `NOTION_JOURNAL_DB_ID`
- добавить раздел Journal в списке компонентов
- Обновить `docs/current/ai.md`:
- описать, что агент умеет создавать и искать записи дневника
- описать правила заполнения полей и шкалу 1-5
- Обновить `README.md`:
- добавить ссылку на Journal DB

### 6) Версия

- Поднять версию в [`apps/todo_bot/package.json`](apps/todo_bot/package.json): `0.1.7 -> 0.1.8`

## Проверка (dev)

- Убедиться, что база Journal доступна интеграции по `NOTION_TOKEN` (успешный `getDatabase`).
- Прогоны в Telegram:
- создать запись дневника текстом (с датой, без даты, с эмоциями)
- list за сегодня или последние N
- find по слову
- update полей (например mood/energy)
- archive по найденной записи

## Замечания по рискам

- Если Notion вернет `option not found` - это сигнал, что мы попытались записать несуществующую опцию. В этом случае должно сработать поведение: очистить поле и запросить уточнение.