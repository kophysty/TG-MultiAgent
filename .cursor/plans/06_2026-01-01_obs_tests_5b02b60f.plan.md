---
name: 06_2026-01-01_obs_tests
overview: "Дополняем план 05: делаем расширенную наблюдаемость (структурные логи, event_log в Postgres, trace_id, диагностический bundle скрипт) и автотесты на самые частые ошибки (неверный intent/tool выбор, нормализации, executor). Docker Compose для prod остается последним пунктом."
todos:
  - id: obs-pg-event-log
    content: Добавить миграцию 009_event_log.sql и repo для записи/query/purge событий (TTL default 90 дней).
    status: completed
  - id: obs-trace-id
    content: Сделать trace_id на каждый incoming update и протащить его через planner/executor/notion/telegram, писать decision trail в event_log.
    status: completed
    dependencies:
      - obs-pg-event-log
  - id: obs-diag-bundle-cli
    content: "Добавить CLI apps/diag: собрать bundle (versions + env snapshot sanitized + pg срез event_log/chat_memory/sent_reminders/sync/security + tail локальных логов при наличии)."
    status: completed
    dependencies:
      - obs-trace-id
  - id: obs-healthcheck-cli
    content: Добавить healthcheck CLI (postgres/notion/telegram) с JSON отчетом и exit codes, пригодно для Docker healthcheck позже.
    status: completed
    dependencies:
      - obs-pg-event-log
  - id: tests-runner-setup
    content: Добавить node:test структуру и npm test scripts (без внешнего раннера).
    status: completed
  - id: tests-core-helpers
    content: "Unit tests для todo_bot_helpers: даты/время, fuzzy variants, matchers, нормализации."
    status: pending
    dependencies:
      - tests-runner-setup
  - id: tests-executor-routing
    content: "Unit tests для todo_bot_executor: routing, patch semantics (undefined vs null), fallback behaviors."
    status: pending
    dependencies:
      - tests-runner-setup
  - id: evals-dev-harness
    content: Dev harness для dataset прогонов реального planner (не обязателен в CI), отчет по mismatch.
    status: pending
    dependencies:
      - tests-runner-setup
  - id: docs-observability
    content: "Обновить RU документацию: diag bundle, event_log, healthcheck, тесты (и bump версии при функциональных изменениях)."
    status: pending
    dependencies:
      - obs-diag-bundle-cli
      - tests-core-helpers
      - tests-executor-routing
---

# План: observability + diag bundle + автотесты (дополнение к ctx/memory)

## Контекст

Сейчас отладка опирается в основном на stdout и `TG_DEBUG` (`debugLog`), плюс есть sanitize (`core/runtime/log_sanitize.js`). Тестового раннера и `npm test` в репозитории пока нет.Цель этого дополнения: сделать так, чтобы при проблеме "бот не так понял" мы могли быстро получить полный след: что пришло, что planner решил, что executor сделал, куда сходил, что вернулось, и как воспроизвести.

## Изменения в плане 05

Расширяем пункт 6 (health + logging) и добавляем отдельный блок автотестов.

## 6) Расширенная система логирования и диагностики

### 6.1 Принципы

- Логи должны быть:
- структурные (JSON)
- коррелируемые (trace_id)
- безопасные (редактируем секреты)
- полезные для расследований (decision trail)
- Храним в Postgres только high-signal события, raw stdout оставляем в stdout (Docker logs) или файловом выводе (dev).
- TTL для операционных логов включаем: default 90 дней (настраиваемо).

### 6.2 Postgres: event_log

Добавить миграцию:

- `009_event_log.sql`

Таблица `event_log`:

- `id bigserial primary key`
- `ts timestamptz not null default now()`
- `trace_id text not null`
- `chat_id bigint null`
- `tg_update_id bigint null`
- `tg_message_id bigint null`
- `component text not null` (todo_bot|worker|planner|executor|notion|telegram|security)
- `event text not null` (incoming_message, planner_plan, tool_call, notion_request, notion_response, error, etc)
- `level text not null` (debug|info|warn|error)
- `duration_ms int null`
- `payload jsonb null` (только sanitized)
- запрещено писать raw headers и любые токены. В payload только белый список полей (trace meta, ids, durations, tool names, sizes, previews).

Индексы:

- `(ts desc)`, `(chat_id, ts desc)`, `(trace_id)`

TTL:

- `TG_EVENT_LOG_TTL_DAYS` default 90
- чистка в worker tick (batch delete) или отдельный maintenance tick

### 6.3 Trace id и корреляция

- На каждый incoming update генерируем `trace_id`.
- Пропускаем `trace_id` через весь пайплайн:
- `incoming_message` -> `planner_plan` -> `tool_call` -> `notion_request/response` -> `tg_send`.
- Техническая реализация (предпочтительно): `AsyncLocalStorage` в `core/runtime`, чтобы не протаскивать `trace_id` параметром через десятки функций.

### 6.4 Обогащение логов решением planner и guard-слоем

Логируем отдельными событиями:

- `planner_input_meta`: таймзона, nowIso, какой контекст подмешали (flags), размеры блоков (len), но не секреты
- `planner_output`: `type`, `tool.name`, summary args keys (без больших text)
- `guard_override`: когда мы принудительно выбираем tool (например Journal guard в voice) и почему
- `executor_action`: какой repo метод вызвали и с какими нормализованными параметрами

### 6.5 Диагностический bundle скрипт

Добавить CLI: `apps/diag` (node скрипт), который собирает bundle в `data/diag/`.Формат запуска (пример):

- `node apps/diag/src/main.js --chat-id <id> --since-hours 24 --out data/diag/bundle-<ts>.json`

Что собираем (best-effort, без падения скрипта если чего-то нет):

- Версии:
- `apps/todo_bot/package.json` version
- `apps/reminders_worker/package.json` version
- Env snapshot (только ключи и безопасные значения):
- есть ли `POSTGRES_URL`, `NOTION_*_DB_ID`, `TG_TZ`, `TG_DEBUG`, `TG_BOT_MODE`
- секреты полностью редактируем
- Postgres срез:
- `event_log` по `chat_id` за период
- `chat_messages` и `chat_summaries` (когда появятся)
- `sent_reminders` последние N
- `notion_sync_queue` и `preferences_sync`
- `chat_security_audit` последние N
- Локальные логи (dev):
- tail файлов в `data/logs/` (если включим file logger)
- Системная инфа:
- node version, platform, time

Важно: bundle всегда sanitizes payload (используем общий sanitizer).

- В dev обязательно добавляем `data/diag/` в `.gitignore`, чтобы не коммитить диагностические дампы.

### 6.6 Health checks (расширение)

Добавить healthcheck CLI (без Docker, пригодно и в Docker):

- `check_postgres`: доступ, наличие таблиц миграций
- `check_notion`: доступность DB ids (Tasks, Ideas, Social, Journal, Preferences)
- `check_telegram`: best-effort send в admin chat (или dry-run)

Результат: JSON отчет + exit code.

### 6.7 Где включаем запись событий

- `apps/todo_bot`:
- в `registerTodoBot` вокруг обработки message/callback/voice
- в planner вызове (`planAgentAction`) и executor
- `apps/reminders_worker`:
- вокруг ticks (reminders tick, memory tick)



## Автотесты (уменьшаем ручные прогоны)

### Принципы тестирования для этого проекта

- Делаем оффлайн тесты без Telegram/Notion, чтобы они были быстрыми и стабильными.
- Тестируем:
- эвристики и нормализации (самая частая причина багов)
- contract executor (какой repo метод вызывается)
- guard правила (например Journal override)
- LLM как внешний компонент не тестируем как "истину" в CI (флейки), но делаем dev harness для прогонов dataset.

### Выбор раннера

Используем `node:test` (встроенный) чтобы не тащить тяжелые зависимости.

- Точку входа тестов держим в `core` (пример: `core/tests/*.test.js`), чтобы тестировать helpers/executor без поднятия bot/worker процессов.

### Набор тестов

1) Unit tests: нормализации и парсеры

- `core/dialogs/todo_bot_helpers.js`:
- `inferListHintsFromText`
- `inferDateFromText`, `inferTimeFromText`, `inferDueDateFromUserText`
- `buildQueryVariants`, `normalizeTitleKey` (и цифры `1 2 3 4` -> `1234`)
- `normalizeMultiOptionValue`, `pickBestOptionMatch`

2) Unit tests: executor routing

- `core/dialogs/todo_bot_executor.js`:
- given tool plan -> calls correct repo method
- verifies that `undefined` does not clear fields, `null` clears where expected
- verifies social platform picker fallback when platform missing

3) Unit tests: voice flow guards

- `core/dialogs/todo_bot_voice.js`:
- если текст journal-related и planner вернул chat, мы все равно идем в tool

4) Golden intent dataset (offline)

- Фикстуры `fixtures/intents/*.json`:
- input text
- expected tool name (или expected intent class)
- optional expected args fragments
- Тесты проверяют именно наш routing слой (не OpenAI).

5) Dev-only eval harness (не CI)

- Скрипт `apps/evals`:
- берет dataset
- вызывает реальный planner (если есть ключ)
- сравнивает с expected и пишет отчет



## Обновления документации

- `docs/current/memory.md`: добавить observability, event_log, diag bundle, TTL
- `docs/current/ai.md`: описать trace_id и decision trail (planner/executor)
- `docs/current/commands.md`: добавить команды healthcheck и diag bundle



## Todo (добавка к плану 05)

- `obs-pg-event-log`: миграция `009_event_log.sql` + repo `event_log_repo.js` (insert, query, purge TTL)
- `obs-trace-id`: генерация trace_id и прокидывание через bot/worker/planner/executor
- `obs-diag-bundle-cli`: `apps/diag` CLI, собирает bundle (pg + env + versions + logs)
- `obs-healthcheck-cli`: healthcheck CLI (postgres/notion/telegram)
- `tests-runner-setup`: добавить `node:test` структуру и `npm test` scripts