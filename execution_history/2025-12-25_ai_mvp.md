# Sprint: AI MVP inside polling todo bot (no n8n)

Date: 2025-12-25

## Goal

Add a minimal AI capability into the existing Telegram polling to-do bot so it can distinguish between a user question and a task request, and create a Notion task after explicit confirmation.

## Scope

- In scope:
  - OpenAI integration (model: `gpt-4.1-mini`) behind a runtime flag `TG_AI=1`
  - Question: answer directly in chat
  - Task: extract fields, show a confirmation summary, create in Notion on confirmation
  - Keep legacy `/addtask` deterministic flow unchanged
- Out of scope:
  - n8n orchestration
  - Persistent drafts storage (drafts are in-memory for now)
  - Voice STT pipeline

## Key decisions

- Decision: Introduce a runtime feature flag for AI (`TG_AI=1`)
  - Rationale: Safe rollout and easy fallback to deterministic bot behavior.
  - Alternatives considered: Always-on AI (rejected due to safety and testability).

- Decision: Use OpenAI JSON-only output (`response_format: json_object`)
  - Rationale: Makes parsing stable for task field extraction.
  - Alternatives considered: Free-form text parsing (rejected due to fragility).

## Changes implemented

- Summary:
  - Updated env loading to support standard `KEY=VALUE` variables from repo root `.env` (e.g. `OPENAI_API_KEY`).
  - Added a minimal OpenAI client and task/question classifier that returns strict JSON.
  - Wired the AI flow into the bot message handler:
    - Question: reply directly in chat.
    - Task: show parsed summary + inline Confirm/Cancel.
    - Confirm: create task in Notion (status `Idle`).

## Files changed (high signal)

- `core/runtime/env.js`
  - Added minimal dotenv-like parsing for `KEY=VALUE` lines so `OPENAI_API_KEY` is available when running from `apps/todo_bot/`.

- `core/ai/openai_client.js`
  - Minimal OpenAI HTTP client using `axios`.

- `core/ai/todo_intent.js`
  - AI intent analysis returning strict JSON with `type=question|task` and extracted task fields.

- `core/dialogs/todo_bot.js`
  - Added AI flow behind `TG_AI=1` with debug logs, task draft confirmation, and Notion creation on confirm.

## Validation

- Steps:
  - Start the bot with AI enabled:
    - `cd apps/todo_bot`
    - `TG_BOT_MODE=tests TG_DEBUG=1 TG_AI=1 TG_AI_MODEL=gpt-4.1-mini npm start`
  - In Telegram:
    - Send a question (non-command text) and verify the bot answers.
    - Send a task description text and verify the bot responds with a summary + Confirm/Cancel.
    - Press Confirm and verify `createTask` succeeds in Notion.
- Expected result:
  - Terminal shows `[tg_debug] ai_call`, then `[tg_debug] ai_result`, then `[tg_debug] notion_call` + `ok: true` on confirmation.

## Follow-ups

- Add a simple "draft timeout" and cleanup for in-memory AI drafts.
- Add "correction loop" improvements (explicit "edit" button, better field overwrite rules).
- Add optional category mapping to existing Notion tag options.



